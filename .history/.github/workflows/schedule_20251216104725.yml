# .github/workflows/schedule.yml
name: â° Schedule Data Extraction

on:
  # FutÃ¡si Ã¼tem 15 percenkÃ©nt
  schedule:
    - cron: "*/15 * * * *" 
  workflow_dispatch:

jobs:
  extract_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Source (main) - Forcing a clean clone
            - name: â¬‡ï¸ Force Clean Checkout of Main Branch
              uses: actions/checkout@v4
              with:
                # Explicitly set the branch
                ref: main
                # Perform a shallow clone (fetch-depth 1) is usually enough
                fetch-depth: 1 
                # Ensure repository path is correct (default)
                path: 'ormezo-parking-2'
                
      # 2. Setup Node
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # -----------------------------------------------------------------
      # NEW STEP 2a: Install Chromium and libraries for ChromeDriver/Selenium
      # -----------------------------------------------------------------
      - name: ğŸŒ Install Browser Dependencies (for Selenium)
        run: |
          sudo apt-get update
      # -----------------------------------------------------------------

      # 3. Install Dependencies
      - name: âš™ï¸ Install dependencies
        run: npm install

      # 3a Folder creation
      - name: ğŸ“ Ensure public directory exists
        run: mkdir -p public 
        
      # 4. RUN EXTRACTOR 
      - name: ğŸš€ Run Data Extractor
        run: npm run scrape # 

      # 4a. RUN HTML GENERATION (CRITICAL STEP)
      - name: ğŸ—ï¸ Generate HTML Dashboard
        # This will run your server.js or whatever generates dashboard.html
        run: npm start        

      # 5. Commit and Push (Final Fix)
      - name: ğŸ”„ Commit and Push Updated Files to gh-pages
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: 'public/dashboard.html public/parking-status.json'
          commit_message: "chore: Automatic data update [skip ci]"
          branch: gh-pages
          skip_checkout: true