<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <title>Ormezo Parkoló státusz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Parkoló státusz</h1>
    <div id="report-time" class="meta"></div>
    <main id="parking-grid" class="grid"></main>

    <script>
        function timeDiffString(updated) {
            try {
                // HA AZ IDŐPONT NEM TARTALMAZ 'T' VAGY 'Z' KARAKTERT (pl. '2025-12-13 15:26:26'),
                // feltételezzük, hogy az helyi idő (CET/CEST) és hozzáadjuk a 'T' jelölést.
                let dateString = updated;
                if (updated && !updated.includes("T") && !updated.includes("Z")) {
                    dateString = updated.replace(" ", "T");
                }

                const now = new Date();
                const upd = new Date(dateString); 
                
                const diffMs = now - upd;
                const diffMin = Math.floor(diffMs / 60000);
                if (diffMin < 1) return "épp most";
                if (diffMin < 60) return diffMin + " perce";
                const diffH = Math.floor(diffMin / 60);
                if (diffH < 24) return diffH + " órája";
                const diffD = Math.floor(diffH / 24);
                return diffD + " napja";
            } catch {
                return updated;
            }
        }

        async function refreshParkingStatus() {
            try {
                // 1. Status JSON betöltése (kötelező)
                const statusRes = await fetch("parking-status.json?ts=" + Date.now(), { cache: "no-store" });
                if (!statusRes.ok) throw new Error("status JSON nem található vagy 404 hiba");
                
                const statusData = await statusRes.json();

                // 2. URL JSON betöltése (opcionális)
                let urlsData = [];
                try {
                    const urlsRes = await fetch("urls.json?ts=" + Date.now(), { cache: "no-store" });
                    if (urlsRes.ok) urlsData = await urlsRes.json();
                } catch {
                    console.warn("urls.json nem elérhető, linkek kihagyva");
                }

                // 3. Adatstruktúra azonosítása és items kinyerése
                let items = [];
                let dataContainer = statusData; 

                // A) Ha a JSON be van ágyazva (statusData.items.items)
                if (statusData && statusData.items && Array.isArray(statusData.items.items)) {
                    items = statusData.items.items;
                    dataContainer = statusData.items; 
                } 
                // B) Ha a szabványos formátum: statusData.items (ahol az items már a tömb)
                else if (statusData && Array.isArray(statusData.items)) {
                    items = statusData.items;
                } 
                // C) Ha a gyökér a tömb
                else if (statusData && Array.isArray(statusData)) {
                    items = statusData;
                }
            
                // VÉGSŐ VÉDELEM: biztosítjuk, hogy az 'items' tömb legyen a forEach előtt.
                if (!Array.isArray(items)) {
                    console.error("HIBA: Az adatstruktúra nem megfelelő tömböt szolgáltatott. Folytatás üres tömbbel.");
                    items = []; 
                }

                // 4. Grid ürítése
                const grid = document.getElementById("parking-grid");
                grid.innerHTML = "";
                
                // 5. Fejléc frissítése
                let headerTime = dataContainer.fetched_at || dataContainer.timestamp || statusData.report_time;

                if (items.length > 0) {
                    // Megkeressük a legfrissebb időpontot az elemek között
                    const latestItemTime = items.reduce((max, item) => 
                        (item.updated && item.updated > max) ? item.updated : max, items[0].updated);
                    
                    // A fejléc idejét frissítjük, ha az elemek között frissebbet találtunk
                    if (latestItemTime && new Date(latestItemTime.replace(" ", "T")) > new Date((headerTime || "").replace(" ", "T"))) {
                        headerTime = latestItemTime;
                    }
                }

                if (headerTime) {
                    const relative = timeDiffString(headerTime);
                    // Itt is a robusztusabb dateString-et használjuk a toLocaleString-hez
                    const dateStringForFormat = headerTime.includes("T") || headerTime.includes("Z") ? headerTime : headerTime.replace(" ", "T");
                    const updDate = new Date(dateStringForFormat); 
                    
                    document.getElementById("report-time").textContent =
                        "Frissítve: " + updDate.toLocaleString("hu-HU") + " (" + relative + ")";
                } else if (items.length > 0) {
                    // Visszaesés az első elemre, ha nincs fejlécidő
                    const updated = items[0].updated;
                    const updDate = new Date(updated.replace(" ", "T"));
                    const relative = timeDiffString(updated);
                    document.getElementById("report-time").textContent =
                        "Frissítve: " + updDate.toLocaleString("hu-HU") + " (" + relative + ") (külső forrás)";
                }
                
                // 6. Kártyák generálása
                items.forEach(entry => { 
                    // Telítettség (Foglalt helyek aránya) - HELYESEN JAVÍTVA
                    const percent = (entry.total && entry.total > 0) ? 
                        Math.round(((entry.total - entry.free) / entry.total) * 100) : 0; 
                    
                    const relative = timeDiffString(entry.updated);
                    const urlEntry = urlsData.find(u => u.id === entry.id);
                    const detailUrl = urlEntry ? urlEntry.url : "#";

                    const card = document.createElement("a");
                    card.className = "card";
                    card.href = detailUrl;
                    card.target = "_blank";
                    card.innerHTML = `
                            <div class="left">
                                <div class="label">${entry.label}</div>
                                <div class="bar-wrap">
                                    <div class="bar">
                                        <div class="fill" style="width:${percent}%"></div>
                                    </div>
                                    <div class="pct">${percent}%</div>
                                </div>
                            </div>
                            <div class="numbers">
                                <div class="count">${entry.free}</div>
                                <div class="total">/${entry.total}</div>
                                <div class="timestamp">${relative}</div>
                            </div>
                        `;
                    grid.appendChild(card);
                });

            } catch (err) { // FŐ CATCH BLOKK KEZELÉSE
                console.error("Hiba a JSON betöltésekor:", err);
                if (err.message.includes("JSON")) {
                    document.getElementById("report-time").textContent = "Nem sikerült betölteni az adatokat. (Érvénytelen JSON)";
                } else {
                    document.getElementById("report-time").textContent = "Nem sikerült betölteni az adatokat.";
                }
            }
        }

    window.onload = () => {
            refreshParkingStatus();
            setInterval(refreshParkingStatus, 60000);
        };
    </script>

</body>
</html>