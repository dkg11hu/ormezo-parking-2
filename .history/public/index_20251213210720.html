<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <title>Ormezo Parkoló státusz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #f7f7f8;
            margin: 0;
            padding: 20px;
        }

        h1 {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        @media (orientation:portrait) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        @media (orientation:landscape) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .card {
            background: #fff;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-decoration: none;
            color: inherit;
        }

        .label {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .bar-wrap {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .bar {
            background: #eef2f4;
            height: 12px;
            width: 160px;
            border-radius: 8px;
            overflow: hidden;
        }

        .fill {
            height: 100%;
            background: linear-gradient(90deg, #2ea44f, #1b8f3a);
        }

        .pct {
            min-width: 40px;
            text-align: right;
            font-size: 0.9rem;
            color: #666;
        }

        .numbers {
            text-align: right;
            min-width: 84px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .count {
            font-weight: 700;
            font-size: 1rem;
        }

        .total {
            color: #666;
            font-size: 0.9rem;
        }

        .timestamp {
            color: #999;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <h1>Parkoló státusz</h1>
    <div id="report-time" class="meta"></div>
    <main id="parking-grid" class="grid"></main>

    <script>
        function timeDiffString(updated) {
            try {
                // HA AZ IDŐPONT NEM TARTALMAZ 'T' VAGY 'Z' KARAKTERT (pl. '2025-12-13 15:26:26'),
                // feltételezzük, hogy az helyi idő (CET/CEST) és hozzáadjuk a 'T' jelölést.
                let dateString = updated;
                if (updated && !updated.includes("T") && !updated.includes("Z")) {
                    dateString = updated.replace(" ", "T");
                }

                const now = new Date();
                const upd = new Date(dateString); 
                
                const diffMs = now - upd;
                const diffMin = Math.floor(diffMs / 60000);
                if (diffMin < 1) return "épp most";
                if (diffMin < 60) return diffMin + " perce";
                const diffH = Math.floor(diffMin / 60);
                if (diffH < 24) return diffH + " órája";
                const diffD = Math.floor(diffH / 24);
                return diffD + " napja";
            } catch {
                return updated;
            }
        }

        async function refreshParkingStatus() {
            try {
                // 1. Status JSON betöltése (kötelező)
                const statusRes = await fetch("parking-status.json?ts=" + Date.now(), { cache: "no-store" });
                if (!statusRes.ok) throw new Error("status JSON nem található vagy 404 hiba");
                
                const statusData = await statusRes.json();

                // 2. URL JSON betöltése (opcionális)
                let urlsData = [];
                try {
                    const urlsRes = await fetch("urls.json?ts=" + Date.now(), { cache: "no-store" });
                    if (urlsRes.ok) urlsData = await urlsRes.json();
                } catch {
                    console.warn("urls.json nem elérhető, linkek kihagyva");
                }

                // 3. Adatstruktúra azonosítása és items kinyerése (JAVÍTOTT RÉSZ)
                let items = [];
                let dataContainer = statusData; 

                // 1. Ha a JSON be van ágyazva (statusData.items.items)
                if (statusData && statusData.items && Array.isArray(statusData.items.items)) {
                    items = statusData.items.items;
                    dataContainer = statusData.items; 
                } 
                // 2. Ha a szabványos formátum: statusData.items (ahol az items már a tömb)
                else if (statusData && Array.isArray(statusData.items)) {
                    items = statusData.items;
                } 
                // 3. Ha a gyökér a tömb
                else if (statusData && Array.isArray(statusData)) {
                    items = statusData;
                }
            
                // VÉGSŐ VÉDELEM a TypeError elkerülésére (ami a problémád forrása)
                if (!Array.isArray(items)) {
                    console.error("Hiba: Az 'items' változó nem tömb. A JSON struktúra nem illeszkedik a várt formátumokhoz.");
                    items = []; // Biztosítjuk, hogy az items egy tömb legyen, mielőtt forEach-et hívunk
                }

                // 4. Grid ürítése
                const grid = document.getElementById("parking-grid");
                grid.innerHTML = "";
                
                // 5. Fejléc frissítése (fetched_at priorizálása a friss időpont miatt)
                let headerTime = dataContainer.fetched_at || dataContainer.timestamp || statusData.report_time;

                if (items.length > 0) {
                    // ... (megtartva a korábbi logika: a legfrissebb updated időt is megnézi)
                    const latestItemTime = items.reduce((max, item) => 
                        (item.updated && item.updated > max) ? item.updated : max, items[0].updated);
                    
                    if (latestItemTime && new Date(latestItemTime.replace(" ", "T")) > new Date((headerTime || "").replace(" ", "T"))) {
                        headerTime = latestItemTime;
                    }
                }


                if (headerTime) {
                    const updated = headerTime;
                    const updDate = new Date(updated.replace(" ", "T")); 
                    
                    const relative = timeDiffString(updated);
                    
                    document.getElementById("report-time").textContent =
                        "Frissítve: " + updDate.toLocaleString("hu-HU") + " (" + relative + ")";
                } else if (items.length > 0) {
                    const updated = items[0].updated;
                    const updDate = new Date(updated.replace(" ", "T"));
                    const relative = timeDiffString(updated);
                    document.getElementById("report-time").textContent =
                        "Frissítve: " + updDate.toLocaleString("hu-HU") + " (" + relative + ") (külső forrás)";
                }
                
                // 6. Kártyák generálása
                items.forEach(entry => { // Ez a sor már biztosan nem fog hibát dobni
                    // Visszaállítjuk a helyes telítettség számítást (FOGLALT hely aránya)
                    const percent = (entry.total && entry.total > 0) ? 
                        Math.round(((entry.total - entry.free) / entry.total) * 100) : 0; 
                    
                    const relative = timeDiffString(entry.updated);
                    const urlEntry = urlsData.find(u => u.id === entry.id);
                    const detailUrl = urlEntry ? urlEntry.url : "#";

                    const card = document.createElement("a");
                    card.className = "card";
                    card.href = detailUrl;
                    card.target = "_blank";
                    card.innerHTML = `
                            <div class="left">
                                <div class="label">${entry.label}</div>
                                <div class="bar-wrap">
                                    <div class="bar">
                                        <div class="fill" style="width:${percent}%"></div>
                                    </div>
                                    <div class="pct">${percent}%</div>
                                </div>
                            </div>
                            <div class="numbers">
                                <div class="count">${entry.free}</div>
                                <div class="total">/${entry.total}</div>
                                <div class="timestamp">${relative}</div>
                            </div>
                        `;
                    grid.appendChild(card);
                });

            } catch (err) { // FŐ CATCH BLOKK KEZELÉSE
                console.error("Hiba a JSON betöltésekor:", err);
                if (err.message.includes("JSON")) {
                    document.getElementById("report-time").textContent = "Nem sikerült betölteni az adatokat. (Érvénytelen JSON)";
                } else {
                    document.getElementById("report-time").textContent = "Nem sikerült betölteni az adatokat.";
                }
            }
        }

    window.onload = () => {
            refreshParkingStatus();
            setInterval(refreshParkingStatus, 60000);
        };
    </script>

</body>
</html>