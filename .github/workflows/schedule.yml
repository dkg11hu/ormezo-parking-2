# .github/workflows/schedule.yml
name: â° Schedule Data Extraction

on:
  # Manual trigger in the GitHub Actions UI
  workflow_dispatch:
  # Schedule to run every 15 minutes
  schedule:
    - cron: "*/15 * * * *" 

jobs:
  extract_and_deploy:
    runs-on: ubuntu-latest
    permissions: 
          contents: write # This grants the token permission to commit and push files.
          pages: write    # Best practice for GitHub Pages deployment actions.
          id-token: write # Often needed for OIDC/security in modern GitHub actions.
    steps:
      # 1. Checkout Source (main) - Forcing a clean clone
      - name: â¬‡ï¸ Force Clean Checkout of Main Branch
        uses: actions/checkout@v4
        with:
          # Explicitly set the branch
          ref: main
          # Perform a shallow clone (fetch-depth 1) is usually enough
          fetch-depth: 1 
          # Ensure repository path is correct (default)
          # Note: If your repository name is 'ormezo-parking-2', this path is correct.
          
      # 2. Setup Node
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'


      # -----------------------------------------------------------------
      # NEW STEP 2a: Install Chromium and libraries for ChromeDriver/Selenium
      # NOTE: This step is missing the actual installation command.
      # You may need to add: `sudo apt-get install chromium-browser` or similar
      # -----------------------------------------------------------------
      - name: ğŸŒ Install Browser Dependencies (for Selenium)
        run: sudo apt-get update

      # 3. Install Dependencies
      - name: âš™ï¸ Install dependencies
        run: npm install

      # 3a Folder creation
      - name: ğŸ“ Ensure public directory exists
        run: mkdir -p public 
        
      # 4. RUN EXTRACTOR 
      - name: ğŸš€ Run Data Extractor
        run: npm run scrape

      # 4a. RUN HTML GENERATION (CRITICAL STEP)
      - name: ğŸ—ï¸ Generate HTML Dashboard
        # This will run your server.js which should generate the dashboard.html and parking-status.json
        run: npm start

      # 5. Commit and Push (Final Fix)
      - name: ğŸ”„ Commit and Push Updated Files to gh-pages
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # These are the files created by the scraper and the npm start script
          file_pattern: 'public/parking-status.json'
          commit_message: "chore: Automatic data update [skip ci]"
          branch: gh-pages
          skip_checkout: true
          # ADD THIS LINE TEMPORARILY:
          push_options: --force
